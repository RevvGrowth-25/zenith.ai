{% extends "base.html" %}

{% block title %}AI Overview - AI Search Analytics{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <h1 class="text-3xl font-bold text-gray-900">AI Overview</h1>
                <p class="mt-2 text-gray-600">Get comprehensive AI-powered overviews for any question</p>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        {% if not service_configured %}
        <!-- Configuration Warning -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Configuration Required</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>To use AI Overview, you need to set up API keys:</p>
                        <ul class="list-disc list-inside mt-2">
                            <li>OPENAI_API_KEY - Get from <a href="https://platform.openai.com/api-keys" target="_blank" class="underline">OpenAI Platform</a></li>
                            <li>SERPAPI_KEY - Get from <a href="https://serpapi.com/manage-api-key" target="_blank" class="underline">SerpAPI</a></li>
                        </ul>
                        <p class="mt-2">Add these to your environment variables or .env file.</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
            <div class="relative">
                <input
                    type="text"
                    id="searchQuery"
                    class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Ask me anything... (e.g., How to start freelancing?)"
                    maxlength="500"
                    {% if not service_configured %}disabled{% endif %}
                />
                <button
                    id="generateBtn"
                    class="absolute right-2 top-2 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    {% if not service_configured %}disabled{% endif %}
                >
                    Generate Overview
                </button>
            </div>
            <div class="mt-2 text-sm text-gray-500">
                <span id="charCount">0</span>/500 characters
                {% if not service_configured %}
                <span class="text-red-500 ml-2">• Service not configured</span>
                {% endif %}
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-lg shadow-sm border p-6 mb-8">
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">Generating AI overview...</span>
            </div>
            <div class="mt-4 text-sm text-gray-500 text-center">
                This may take 10-30 seconds as we search and analyze multiple sources
            </div>
        </div>

        <!-- Overview Result -->
        <div id="overviewResult" class="hidden bg-white rounded-lg shadow-sm border mb-8">
            <!-- Overview content will be inserted here -->
        </div>

        <!-- Recent Searches -->
        {% if recent_overviews %}
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Overviews</h2>
            <div class="space-y-4">
                {% for overview in recent_overviews %}
                <div class="border-l-4 border-blue-500 pl-4 py-2 cursor-pointer hover:bg-gray-50 rounded"
                     onclick="loadOverview({{ overview.id }})">
                    <div class="font-medium text-gray-900">{{ overview.query }}</div>
                    <div class="text-sm text-gray-500 mt-1">
                        {{ overview.created_at }} •
                        {% if overview.processing_time %}{{ "%.1f"|format(overview.processing_time) }}s •{% endif %}
                        {{ overview.sources_used|length if overview.sources_used else 0 }} sources
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Overview Template -->
<template id="overviewTemplate">
    <div class="p-6">
        <div class="flex items-start justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900" id="overviewQuery"></h2>
            <div class="text-sm text-gray-500" id="overviewMeta"></div>
        </div>

        <!-- AI Overview -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="font-medium text-blue-800">AI Overview</span>
            </div>
            <div class="text-gray-800 leading-relaxed" id="overviewText"></div>
        </div>

        <!-- Sources -->
        <div>
            <h3 class="font-medium text-gray-900 mb-3">Sources</h3>
            <div class="grid gap-3" id="sourcesList">
                <!-- Sources will be inserted here -->
            </div>
        </div>
    </div>
</template>

<!-- Source Item Template -->
<template id="sourceTemplate">
    <div class="border rounded-lg p-3 hover:bg-gray-50">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <h4 class="font-medium text-blue-600 hover:text-blue-800">
                    <a href="" target="_blank" class="source-link"></a>
                </h4>
                <p class="text-sm text-gray-600 mt-1 source-snippet"></p>
                <div class="text-xs text-gray-500 mt-2 source-url"></div>
            </div>
            <div class="ml-3 flex-shrink-0">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 source-status">
                    Content Used
                </span>
            </div>
        </div>
    </div>
</template>

<script>
// Pass service configuration status to JavaScript
window.serviceConfigured = {{ service_configured|tojson }};
</script>
<script src="{{ url_for('static', filename='js/ai-overview.js') }}"></script>
{% endblock %}